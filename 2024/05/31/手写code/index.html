<!DOCTYPE html>
<html lang="">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手写code | 蘑菇小记</title>
    <link rel="stylesheet" href="/css/breeze.css">
    <script src="/js/toc.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const backToTopButton = document.getElementById('back-to-top');

            // 当页面滚动超过 300px 时显示按钮
            window.onscroll = function() {
                if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                backToTopButton.style.display = "block";
                } else {
                backToTopButton.style.display = "none";
                }
            };
            
            // 点击按钮时平滑滚动回顶部
            backToTopButton.addEventListener('click', function() {
                const scrollToTop = function() {
                    const c = document.documentElement.scrollTop || document.body.scrollTop;
                    if (c > 0) {
                    window.requestAnimationFrame(scrollToTop);
                    window.scrollTo(0, c - c / 8);
                    }
                };
                scrollToTop();
            });
        });
        window.isMobile = /mobile|android|iphone|ipad|phone/i.test(navigator.userAgent);
    </script>

    
<meta name="generator" content="Hexo 5.4.2"></head>
    
  <body>
    <div class="container">
      <header class="header-container post-header">
    <div class="title">
        <img src="/images/Icon-leaf.png" class="leaf-icon">
        <a href="/">蘑菇小记</a>
    </div>
    <nav class="nav">
        <ul>
            
                <li><a href="/archives" class="nav-item">Archives</a></li>
            
                <li><a href="/about" class="nav-item">About</a></li>
            
          </ul>
    </nav>
</header>

      <div class="main-content">
        
          

<article class="post-detail ">
    <div class="post-title-container">
        <h1 class="post-title">手写code</h1>
    </div>
    <div class="post-meta">
        <time datetime="2024-05-31T07:15:57.000Z">2024-05-31</time>
        
          <div class="post-tags">
            
              <a href="/tags/%E5%A4%8D%E4%B9%A0/" class="post-tag">复习</a>
            
          </div>
        
        
          <div class="post-categories">
            
              <a href="/categories/JS/" class="post-category">JS</a>
            
          </div>
        
  </div>
  <div class="post-content">
    

    <blockquote>
<p><strong>jsonP</strong></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">jsonp</span>(<span class="params">url, callback, success</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> script = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;script&#x27;</span>)</span><br><span class="line">    script.<span class="property">url</span> = url</span><br><span class="line">    script.<span class="property">async</span> = <span class="literal">true</span></span><br><span class="line">    script.<span class="property">type</span> = <span class="string">&#x27;text/javascript&#x27;</span></span><br><span class="line">    <span class="variable language_">window</span>[callback] = <span class="function">(<span class="params">data</span>) =&gt;</span> success &amp;&amp; <span class="title function_">success</span>(data)</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(script)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>xhr</strong></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">使用JS的XMLHttpRequest</span><br><span class="line">fetch API</span><br><span class="line">实现几个要点：设置请求头；处理响应；处理错误；发送请求</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// use XMLHttpRequest</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">httpRequest</span>(<span class="params">method, url, data = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>()</span><br><span class="line">        xhr.<span class="title function_">open</span>(method, url, <span class="literal">true</span>)</span><br><span class="line">        xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/json;charset=utf-8&#x27;</span>)</span><br><span class="line">        xhr.<span class="property">onreadystatechange</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(xhr.<span class="property">readyState</span> === <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(xhr.<span class="property">status</span> === <span class="number">200</span>) <span class="title function_">resolve</span>(<span class="title class_">JSON</span>.<span class="title function_">parse</span>(xhr.<span class="property">responseText</span>))</span><br><span class="line">                <span class="keyword">else</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(xhr.<span class="property">statusText</span>))   </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        xhr.<span class="property">onerror</span> = <span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Network error&#x27;</span>))</span><br><span class="line">        xhr.<span class="title function_">send</span>(data ? <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data) : <span class="literal">null</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// use fetch() </span></span><br><span class="line"><span class="comment">// return Promise</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">httpRequest</span>(<span class="params">method, url, data = <span class="literal">null</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> headers = <span class="keyword">new</span> <span class="title class_">Headers</span>()</span><br><span class="line">    headers.<span class="title function_">append</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> options = &#123;</span><br><span class="line">        method,</span><br><span class="line">        headers,</span><br><span class="line">        <span class="attr">body</span>: data ? <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data) : <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">mode</span>: <span class="string">&#x27;cors&#x27;</span> <span class="comment">//跨域 &#x27;no-cors&#x27; &#x27;same-origin&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这些请求不能有body</span></span><br><span class="line">    <span class="keyword">if</span>([<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;HEAD&#x27;</span>].<span class="title function_">includes</span>(method)) &#123; </span><br><span class="line">        <span class="keyword">delete</span> options.<span class="property">body</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">fetch</span>(url, options) </span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(!response.<span class="property">ok</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(response.<span class="property">status</span>)</span><br><span class="line">            <span class="keyword">return</span> response.<span class="title function_">json</span>()</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data))</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error:&#x27;</span>, error))</span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">// 高级用法，本身没有超时机制，可以结合promise和timeout</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">fetchWithTimeout</span> = (<span class="params">url, options, timeout = <span class="number">5000</span></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">race</span>([</span><br><span class="line">        <span class="title function_">httpRequest</span>(options.<span class="property">methods</span>, url, options.<span class="property">data</span> = <span class="literal">null</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">_, reject</span>) =&gt;</span> <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Timeout&#x27;</span>)), timeout))</span><br><span class="line">    ])</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">fetchWithTimeout</span>(url, &#123; <span class="attr">methods</span>: <span class="string">&#x27;post&#x27;</span>, <span class="attr">data</span>: <span class="literal">null</span> &#125;)</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span><br><span class="line">.<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(data))</span><br><span class="line">.<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;err,&#x27;</span>, err))</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>防抖</strong></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">事件触发n秒后再执行回调函数</span><br><span class="line">如果在n秒内又被触发，则需重新计时</span><br><span class="line">使用场景：多次提交按钮；表单验证；输入框连续输入、校验；搜索框联想词</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">func</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">delay</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">func, delay</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> timerId</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">clearTimeout</span>(timerId)</span><br><span class="line">        timerId = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            func.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">        &#125;, delay)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Example usage:</span></span><br><span class="line"><span class="keyword">const</span> debouncedFunction = <span class="title function_">debounce</span>(<span class="function">() =&gt;</span> &#123;...&#125;, <span class="number">300</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>节流 throttle</strong></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">在规定时间间隔内只执行一次回调；在单位时间内触发多次函数，但只有一次生效</span><br><span class="line">将高频操作转为低频操作；降低频率</span><br><span class="line">使用场景：滚动事件；resize事件</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">func</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">delay</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">throttle</span>(<span class="params">func, delay</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> lastExcutedTime = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">        <span class="keyword">if</span>(now - lastExcutedTime &gt;= delay) &#123;</span><br><span class="line">            func.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args)</span><br><span class="line">            lastExcutedTime = now</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Example usage:</span></span><br><span class="line"><span class="keyword">const</span> throttledFunction = <span class="title function_">throttle</span>(<span class="function">() =&gt;</span> &#123;...&#125;, <span class="number">300</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>instanceof</strong></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">判断是什么类型的对象，确定值的引用类型；确定原型和实例的关系</span><br><span class="line">实现：遍历对象原型链向上查找</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">instance</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">construtor</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> <span class="variable">boolean</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">instanceof</span>(<span class="params">instance, construtor</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> prototype = constructor.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line">    <span class="keyword">const</span> proto = <span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(instance)</span><br><span class="line">    <span class="keyword">while</span> (proto != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (proto === prototype) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        proto = <span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(proto) <span class="comment">// 向上查找原型链</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>setPrototypeOf</strong></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">给指定对象设置原型 A.setPrototypeOf(B)</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">obj</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">construtor</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> <span class="variable">object</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setPrototypeOf</span>(<span class="params">obj, construtor</span>) &#123;</span><br><span class="line">    obj.<span class="property">__proto__</span> = constructor.<span class="property"><span class="keyword">prototype</span></span></span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>new 运算符</strong></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">实现需要几个步骤：</span><br><span class="line">1. 创建一个新对象；使用普通对象字面量创建更好，它具有默认原型链，兼容性更好</span><br><span class="line">   - Object.create(null) 虽然可以工作，但创建的对象没有原型，可能不具备某些方法，出现意外行为 </span><br><span class="line">2. 执行原型连接</span><br><span class="line">3. 绑定this到新对象</span><br><span class="line">4. 如果没有返回其他对象就返回该对象</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">construtor</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">args</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> <span class="variable">object</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">ObjectFactory</span>(<span class="params">construtor, ...args</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> obj = &#123;&#125; <span class="comment">// 1</span></span><br><span class="line">    obj.<span class="property">__proto__</span> = construtor.<span class="property"><span class="keyword">prototype</span></span> <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">const</span> result = constructor.<span class="title function_">apply</span>(obj, args) <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">return</span> result === <span class="string">&#x27;object&#x27;</span> &amp;&amp; result !== <span class="literal">null</span> ? result : obj <span class="comment">// 4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Object.create</strong></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">创建一个新对象，使用现有对象为新对象提供原型proto</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">create</span> (<span class="params">o</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!o) <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">F</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    F.<span class="property"><span class="keyword">prototype</span></span> = o</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> F</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Object</span>.<span class="property">create</span> = <span class="title class_">Object</span>.<span class="property">create</span> || create</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>深拷贝</strong></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 不能拷贝函数、循环引用、RegExp及Date等特殊对象</span></span><br><span class="line"><span class="comment">// 对象有循环引用时会报错</span></span><br><span class="line"><span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(str))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 手动递归</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">deepClone</span>(<span class="params">obj, hash = <span class="keyword">new</span> <span class="built_in">WeakMap</span>()</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(obj === <span class="literal">null</span> || <span class="keyword">typeof</span> obj !== <span class="string">&#x27;object&#x27;</span>) <span class="keyword">return</span> obj <span class="comment">// 排除原始值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理循环引用</span></span><br><span class="line">    <span class="keyword">if</span>(hash.<span class="title function_">has</span>(obj))&#123;</span><br><span class="line">        <span class="keyword">return</span> hash.<span class="title function_">get</span>(obj)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> result</span><br><span class="line">    <span class="comment">//  处理特殊对象</span></span><br><span class="line">    <span class="keyword">if</span>(obj <span class="keyword">instanceof</span> <span class="title class_">Date</span>) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> <span class="title class_">Date</span>(obj)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">RegExp</span>) &#123;</span><br><span class="line">        result = <span class="keyword">new</span> <span class="title class_">RegExp</span>(obj)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="title class_">Array</span>.<span class="title function_">isArray</span>(obj)) &#123;</span><br><span class="line">        result = []</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hash.<span class="title function_">set</span>(obj, result) <span class="comment">// 保存引用，避免递归死循环</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">const</span> key <span class="keyword">in</span> obj) &#123;</span><br><span class="line">        <span class="keyword">if</span>(obj.<span class="title function_">hasOwnProperty</span>(key)) &#123; <span class="comment">// 避免拷贝原型链上的属性，只处理对象本身的字段</span></span><br><span class="line">            result[key] = <span class="title function_">deepClone</span>(obj[key], hash)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">deepClone</span>(<span class="params">obj, hash = <span class="keyword">new</span> <span class="built_in">WeakMap</span>()</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Object</span>(obj) !== obj) <span class="keyword">return</span> obj; <span class="comment">// 原始类型</span></span><br><span class="line">  <span class="keyword">if</span> (hash.<span class="title function_">has</span>(obj)) <span class="keyword">return</span> hash.<span class="title function_">get</span>(obj); <span class="comment">// 处理循环引用</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 特殊对象处理</span></span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">Date</span>) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(obj);</span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">RegExp</span>) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RegExp</span>(obj);</span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">Map</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">    hash.<span class="title function_">set</span>(obj, result);</span><br><span class="line">    obj.<span class="title function_">forEach</span>(<span class="function">(<span class="params">v, k</span>) =&gt;</span> result.<span class="title function_">set</span>(<span class="title function_">deepClone</span>(k, hash), <span class="title function_">deepClone</span>(v, hash)));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">Set</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">new</span> <span class="title class_">Set</span>();</span><br><span class="line">    hash.<span class="title function_">set</span>(obj, result);</span><br><span class="line">    obj.<span class="title function_">forEach</span>(<span class="function"><span class="params">v</span> =&gt;</span> result.<span class="title function_">add</span>(<span class="title function_">deepClone</span>(v, hash)));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 函数直接返回（不处理上下文绑定）</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj === <span class="string">&#x27;function&#x27;</span>) <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 普通对象 / 数组</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(obj) ? [] : <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(obj));</span><br><span class="line">  hash.<span class="title function_">set</span>(obj, result);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理字符串 key + Symbol key</span></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(obj);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">of</span> keys) &#123;</span><br><span class="line">    result[key] = <span class="title function_">deepClone</span>(obj[key], hash);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> original = &#123;</span><br><span class="line">  <span class="attr">num</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">str</span>: <span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">  <span class="attr">bool</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">date</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(),</span><br><span class="line">  <span class="attr">reg</span>: <span class="regexp">/test/gi</span>,</span><br><span class="line">  <span class="attr">map</span>: <span class="keyword">new</span> <span class="title class_">Map</span>([[&#123; <span class="attr">x</span>: <span class="number">1</span> &#125;, <span class="string">&#x27;value&#x27;</span>]]),</span><br><span class="line">  <span class="attr">set</span>: <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]),</span><br><span class="line">  <span class="attr">symKey</span>: <span class="title class_">Symbol</span>(<span class="string">&#x27;sym&#x27;</span>),</span><br><span class="line">  <span class="attr">fn</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hi&#x27;</span>),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">original.<span class="property">self</span> = original; <span class="comment">// 循环引用</span></span><br><span class="line">original[original.<span class="property">symKey</span>] = <span class="string">&#x27;symbol value&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clone = <span class="title function_">deepClone</span>(original);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(clone);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>JSON.parse</strong></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">parseJSON</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">eval</span>(<span class="string">`(<span class="subst">$&#123;str&#125;</span>)`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>stringToNumber</strong></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">处理负号</span><br><span class="line">根据ASCII码转换对应的数字</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@params</span> <span class="variable">str</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">stringToNumber</span>(<span class="params">str</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> result = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> <span class="built_in">isNaN</span>, isNegative = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">let</span> startIndex = <span class="number">0</span></span><br><span class="line">    <span class="comment">// 处理负号</span></span><br><span class="line">    <span class="keyword">if</span>(str[<span class="number">0</span>] === <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">        isNegative = <span class="literal">true</span></span><br><span class="line">        startIndex = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(startIndex; startIndex &lt; str.<span class="property">length</span>; startIndex++) &#123;</span><br><span class="line">        <span class="comment">// 如果不是数字则停止转换</span></span><br><span class="line">        <span class="keyword">if</span>(str[startIndex] &lt; <span class="string">&#x27;0&#x27;</span> || str[startIndex] &gt; <span class="string">&#x27;9&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">isNaN</span> = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> digitValue = str.<span class="title function_">charCodeAt</span>(startIndex) - <span class="string">&#x27;0&#x27;</span>.<span class="title function_">charCodeAt</span>(<span class="number">0</span>)</span><br><span class="line">        result = result * <span class="number">10</span> + digitValue</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">isNaN</span>) <span class="keyword">return</span> <span class="title class_">NaN</span></span><br><span class="line">    <span class="keyword">return</span> isNegative ?  -result : result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Promise</strong></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">实现需要几个要点：</span><br><span class="line">1. 状态state，必须处于这三种之一：pending、fulfilled、rejected</span><br><span class="line">2. 状态转移：从pending到fulfilled 和 从pending到rejected；状态变化后不能改变或回退</span><br><span class="line">3. 传入异步处理器executor，定义 resolve 和 reject 函数；fulfilledCallbacks、rejectedCallbacks</span><br><span class="line">4. then 方法：返回一个新的promise；接收2个可选参数onFulfilled 和 onRejected；可以被同一个promise调用多次</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">StateEnum</span> = &#123;</span><br><span class="line">    <span class="string">&#x27;pending&#x27;</span>: <span class="string">&#x27;PENDING&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;fulfilled&#x27;</span>: <span class="string">&#x27;FULFILLED&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;rejected&#x27;</span>: <span class="string">&#x27;REJECTED&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">myPromise</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">executor</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">pending</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value</span> = <span class="literal">undefined</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">reason</span> = <span class="literal">undefined</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">fulfilledCallbacks</span>= []</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">rejectedCallbacks</span>= []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">resolve</span> = (<span class="params">value</span>) =&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">pending</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">fulfilled</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line">                fulfilledCallbacks.<span class="title function_">forEach</span>(<span class="function"><span class="params">cb</span> =&gt;</span> <span class="title function_">cb</span>(<span class="variable language_">this</span>.<span class="property">vlaue</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">reject</span> = (<span class="params">reason</span>) =&gt; &#123;</span><br><span class="line">           <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">pending</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">state</span> = <span class="title class_">StateEnum</span>.<span class="property">rejected</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">reason</span> = reason</span><br><span class="line">                rejectedCallbacks.<span class="title function_">forEach</span>(<span class="function"><span class="params">cb</span> =&gt;</span> <span class="title function_">cb</span>(<span class="variable language_">this</span>.<span class="property">reason</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="title function_">executor</span>(resolve, reject)</span><br><span class="line">        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">then</span>(<span class="params">onFulfilled, onRejected</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">myPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">pending</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">fulfilledCallbacks</span>.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="title function_">resolve</span>(<span class="title function_">onFulfilled</span>(<span class="variable language_">this</span>.<span class="property">value</span>))</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">                            <span class="title function_">reject</span>(err)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">rejectedCallbacks</span>.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="title function_">resolve</span>(<span class="title function_">onRejected</span>(<span class="variable language_">this</span>.<span class="property">reason</span>))</span><br><span class="line">                        &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">                            <span class="title function_">reject</span>(err)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">fulfilled</span>) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="title function_">resolved</span>(<span class="title function_">onFulfilled</span>(<span class="variable language_">this</span>.<span class="property">value</span>))</span><br><span class="line">                    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">                        <span class="title function_">reject</span>(err)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span> === <span class="title class_">StateEnum</span>.<span class="property">rejected</span>) &#123;</span><br><span class="line">                <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="title function_">resolved</span>(<span class="title function_">onRejected</span>(<span class="variable language_">this</span>.<span class="property">reason</span>))</span><br><span class="line">                    &#125; <span class="keyword">catch</span>(err) &#123;</span><br><span class="line">                        <span class="title function_">reject</span>(err)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>forEach</strong></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">1. 检查传入的参数是否是函数</span><br><span class="line">2. 遍历数组，对每个元素调用传入的函数</span><br><span class="line">3. 提供当前元素、索引和数组作为参考</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span>)&#123;</span><br><span class="line">    <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span> = <span class="keyword">function</span>(<span class="params">callback, thisArg</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> callback !== <span class="string">&#x27;function&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(callback + <span class="string">&#x27;is not a function &#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> array = <span class="variable language_">this</span></span><br><span class="line">    <span class="keyword">const</span> length = array.<span class="property">length</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>;i &lt; length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i <span class="keyword">in</span> array) &#123;</span><br><span class="line">            callback.<span class="title function_">call</span>(thisArg, array[i], i, array)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  </div>
</article>

        
        
      </div>
      <footer class="footer">
    <div class="footer-content">
        <p>&copy; 2025 蘑菇小记</p>
        <p class="copyright">All rights reserved.</p>
    </div>
</footer>
    </div>
    <button id="back-to-top" title="回到顶部">↑</button>
  </body>
</html>
