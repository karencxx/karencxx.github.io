<!DOCTYPE html>
<html lang="">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>snabbdom浅读源码 | 蘑菇小记</title>
    <link rel="stylesheet" href="/css/breeze.css">
    <script src="/js/toc.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const backToTopButton = document.getElementById('back-to-top');

            // 当页面滚动超过 300px 时显示按钮
            window.onscroll = function() {
                if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                backToTopButton.style.display = "block";
                } else {
                backToTopButton.style.display = "none";
                }
            };
            
            // 点击按钮时平滑滚动回顶部
            backToTopButton.addEventListener('click', function() {
                const scrollToTop = function() {
                    const c = document.documentElement.scrollTop || document.body.scrollTop;
                    if (c > 0) {
                    window.requestAnimationFrame(scrollToTop);
                    window.scrollTo(0, c - c / 8);
                    }
                };
                scrollToTop();
            });
        });
        window.isMobile = /mobile|android|iphone|ipad|phone/i.test(navigator.userAgent);
    </script>

    
<meta name="generator" content="Hexo 5.4.2"></head>
    
  <body>
    <div class="container">
      <header class="header-container post-header">
    <div class="title">
        <img src="/images/Icon-leaf.png" class="leaf-icon">
        <a href="/">蘑菇小记</a>
    </div>
    <nav class="nav">
        <ul>
            
                <li><a href="/archives" class="nav-item">Archives</a></li>
            
                <li><a href="/about" class="nav-item">About</a></li>
            
          </ul>
    </nav>
</header>

      <div class="main-content">
        
          

<aside class="post-toc">
    <div class="toc-wrapper collapsed">
  <div class="toc-toggle">
    <span class="toc-toggle-icon"></span>
  </div>
  <div class="toc-content">
    
      <div class="toc-body">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#h-ts"><span class="toc-text">h.ts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#init-ts"><span class="toc-text">init.ts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vnode-ts"><span class="toc-text">vnode.ts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hooks-ts"><span class="toc-text">hooks.ts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#thunk-ts"><span class="toc-text">thunk.ts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tovnode-ts"><span class="toc-text">tovnode.ts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#htmldomapi-ts"><span class="toc-text">htmldomapi.ts</span></a></li></ol>
      </div>
    
  </div>
</div>


</aside>

<article class="post-detail has-toc toc-collapsed">
    <div class="post-title-container">
        <h1 class="post-title">snabbdom浅读源码</h1>
    </div>
    <div class="post-meta">
        <time datetime="2021-03-08T07:19:05.000Z">2021-03-08</time>
        
          <div class="post-tags">
            
              <a href="/tags/source-code/" class="post-tag">source code</a>
            
          </div>
        
        
          <div class="post-categories">
            
              <a href="/categories/snabbdom/" class="post-category">snabbdom</a>
            
          </div>
        
  </div>
  <div class="post-content">
    

    <h2 id="h-ts"><a href="#h-ts" class="headerlink" title="h.ts"></a>h.ts</h2><p><strong>用于生成vnode</strong></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">h</span> (<span class="params"><span class="attr">sel</span>: <span class="built_in">string</span></span>): <span class="title class_">VNode</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">h</span> (<span class="params"><span class="attr">sel</span>: <span class="built_in">string</span>, <span class="attr">data</span>: <span class="title class_">VNodeData</span> | <span class="literal">null</span></span>): <span class="title class_">VNode</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">h</span> (<span class="params"><span class="attr">sel</span>: <span class="built_in">string</span>, <span class="attr">children</span>: <span class="title class_">VNodeChildren</span></span>): <span class="title class_">VNode</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">h</span> (<span class="params"><span class="attr">sel</span>: <span class="built_in">string</span>, <span class="attr">data</span>: <span class="title class_">VNodeData</span> | <span class="literal">null</span>, <span class="attr">children</span>: <span class="title class_">VNodeChildren</span></span>): <span class="title class_">VNode</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">h</span> (<span class="params"><span class="attr">sel</span>: <span class="built_in">any</span>, <span class="attr">b</span>?: <span class="built_in">any</span>, <span class="attr">c</span>?: <span class="built_in">any</span></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">data</span>: <span class="title class_">VNodeData</span> = &#123;&#125;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">children</span>: <span class="built_in">any</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">text</span>: <span class="built_in">any</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">i</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="keyword">if</span> (c !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (b !== <span class="literal">null</span>) &#123;</span><br><span class="line">      data = b</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is.<span class="title function_">array</span>(c)) &#123;</span><br><span class="line">      children = c</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is.<span class="title function_">primitive</span>(c)) &#123;</span><br><span class="line">      text = c</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c &amp;&amp; c.<span class="property">sel</span>) &#123;</span><br><span class="line">      children = [c]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (b !== <span class="literal">undefined</span> &amp;&amp; b !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is.<span class="title function_">array</span>(b)) &#123;</span><br><span class="line">      children = b</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is.<span class="title function_">primitive</span>(b)) &#123;</span><br><span class="line">      text = b</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (b &amp;&amp; b.<span class="property">sel</span>) &#123;</span><br><span class="line">      children = [b]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; data = b &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (children !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; children.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">      <span class="keyword">if</span> (is.<span class="title function_">primitive</span>(children[i])) children[i] = <span class="title function_">vnode</span>(<span class="literal">undefined</span>, <span class="literal">undefined</span>, <span class="literal">undefined</span>, children[i], <span class="literal">undefined</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    sel[<span class="number">0</span>] === <span class="string">&#x27;s&#x27;</span> &amp;&amp; sel[<span class="number">1</span>] === <span class="string">&#x27;v&#x27;</span> &amp;&amp; sel[<span class="number">2</span>] === <span class="string">&#x27;g&#x27;</span> &amp;&amp;</span><br><span class="line">    (sel.<span class="property">length</span> === <span class="number">3</span> || sel[<span class="number">3</span>] === <span class="string">&#x27;.&#x27;</span> || sel[<span class="number">3</span>] === <span class="string">&#x27;#&#x27;</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">addNS</span>(data, children, sel)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">vnode</span>(sel, data, children, text, <span class="literal">undefined</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="init-ts"><a href="#init-ts" class="headerlink" title="init.ts"></a>init.ts</h2><p><strong>patch 用于渲染对比VNode变成真实DOM</strong><br>patch (oldVnode, newVnode)</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">init</span> (<span class="params"><span class="attr">modules</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Partial</span>&lt;<span class="title class_">Module</span>&gt;&gt;, <span class="attr">domApi</span>?: DOMAPI</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">i</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">j</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">cbs</span>: <span class="title class_">ModuleHooks</span> = &#123;</span><br><span class="line">    <span class="attr">create</span>: [],</span><br><span class="line">    <span class="attr">update</span>: [],</span><br><span class="line">    <span class="attr">remove</span>: [],</span><br><span class="line">    <span class="attr">destroy</span>: [],</span><br><span class="line">    <span class="attr">pre</span>: [],</span><br><span class="line">    <span class="attr">post</span>: []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">api</span>: <span class="variable constant_">DOMAPI</span> = domApi !== <span class="literal">undefined</span> ? domApi : htmlDomApi</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; hooks.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">    cbs[hooks[i]] = []</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; modules.<span class="property">length</span>; ++j) &#123;</span><br><span class="line">      <span class="keyword">const</span> hook = modules[j][hooks[i]]</span><br><span class="line">      <span class="keyword">if</span> (hook !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        (cbs[hooks[i]] <span class="keyword">as</span> <span class="built_in">any</span>[]).<span class="title function_">push</span>(hook)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">patch</span> (<span class="params"><span class="attr">oldVnode</span>: <span class="title class_">VNode</span> | <span class="title class_">Element</span>, <span class="attr">vnode</span>: <span class="title class_">VNode</span></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">i</span>: <span class="built_in">number</span>, <span class="attr">elm</span>: <span class="title class_">Node</span>, <span class="attr">parent</span>: <span class="title class_">Node</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">insertedVnodeQueue</span>: <span class="title class_">VNodeQueue</span> = []</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.<span class="property">pre</span>.<span class="property">length</span>; ++i) cbs.<span class="property">pre</span>[i]()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_">isVnode</span>(oldVnode)) &#123;</span><br><span class="line">      oldVnode = <span class="title function_">emptyNodeAt</span>(oldVnode)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldVnode, vnode)) &#123;</span><br><span class="line">      <span class="title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      elm = oldVnode.<span class="property">elm</span>!</span><br><span class="line">      parent = api.<span class="title function_">parentNode</span>(elm) <span class="keyword">as</span> <span class="title class_">Node</span></span><br><span class="line"></span><br><span class="line">      <span class="title function_">createElm</span>(vnode, insertedVnodeQueue)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (parent !== <span class="literal">null</span>) &#123;</span><br><span class="line">        api.<span class="title function_">insertBefore</span>(parent, vnode.<span class="property">elm</span>!, api.<span class="title function_">nextSibling</span>(elm))</span><br><span class="line">        <span class="title function_">removeVnodes</span>(parent, [oldVnode], <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; insertedVnodeQueue.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">      insertedVnodeQueue[i].<span class="property">data</span>!.<span class="property">hook</span>!.<span class="property">insert</span>!(insertedVnodeQueue[i])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.<span class="property">post</span>.<span class="property">length</span>; ++i) cbs.<span class="property">post</span>[i]()</span><br><span class="line">    <span class="keyword">return</span> vnode</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>调用pre钩子函数</li>
<li>判断是否为VNode，不是则创建一个空的vnode</li>
<li>判断是否为同一个节点（判断key和sel），是则调用patchVnode函数</li>
<li>否则调用createElm函数，若父节点存在就插入该父节点并调用removeVnodes函数移除旧节点</li>
<li>循环调用insert钩子函数</li>
<li>循环调用post构造函数</li>
<li>返回vnode (是下次的oldNode)</li>
</ol>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">patchVnode</span> (<span class="params"><span class="attr">oldVnode</span>: <span class="title class_">VNode</span>, <span class="attr">vnode</span>: <span class="title class_">VNode</span>, <span class="attr">insertedVnodeQueue</span>: <span class="title class_">VNodeQueue</span></span>) &#123;</span><br><span class="line">   <span class="keyword">const</span> hook = vnode.<span class="property">data</span>?.<span class="property">hook</span></span><br><span class="line">   hook?.<span class="property">prepatch</span>?.(oldVnode, vnode)</span><br><span class="line">   <span class="keyword">const</span> elm = vnode.<span class="property">elm</span> = oldVnode.<span class="property">elm</span>!</span><br><span class="line">   <span class="keyword">const</span> oldCh = oldVnode.<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">VNode</span>[]</span><br><span class="line">   <span class="keyword">const</span> ch = vnode.<span class="property">children</span> <span class="keyword">as</span> <span class="title class_">VNode</span>[]</span><br><span class="line">   <span class="keyword">if</span> (oldVnode === vnode) <span class="keyword">return</span></span><br><span class="line">   <span class="keyword">if</span> (vnode.<span class="property">data</span> !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cbs.<span class="property">update</span>.<span class="property">length</span>; ++i) cbs.<span class="property">update</span>[i](oldVnode, vnode)</span><br><span class="line">     vnode.<span class="property">data</span>.<span class="property">hook</span>?.<span class="property">update</span>?.(oldVnode, vnode)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode.<span class="property">text</span>)) &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh) &amp;&amp; <span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (oldCh !== ch) <span class="title function_">updateChildren</span>(elm, oldCh, ch, insertedVnodeQueue)</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(ch)) &#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) api.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">       <span class="title function_">addVnodes</span>(elm, <span class="literal">null</span>, ch, <span class="number">0</span>, ch.<span class="property">length</span> - <span class="number">1</span>, insertedVnodeQueue)</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh)) &#123;</span><br><span class="line">       <span class="title function_">removeVnodes</span>(elm, oldCh, <span class="number">0</span>, oldCh.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode.<span class="property">text</span>)) &#123;</span><br><span class="line">       api.<span class="title function_">setTextContent</span>(elm, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldVnode.<span class="property">text</span> !== vnode.<span class="property">text</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldCh)) &#123;</span><br><span class="line">       <span class="title function_">removeVnodes</span>(elm, oldCh, <span class="number">0</span>, oldCh.<span class="property">length</span> - <span class="number">1</span>)</span><br><span class="line">     &#125;</span><br><span class="line">     api.<span class="title function_">setTextContent</span>(elm, vnode.<span class="property">text</span>!)</span><br><span class="line">   &#125;</span><br><span class="line">   hook?.<span class="property">postpatch</span>?.(oldVnode, vnode)</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>触发prepatch钩子</li>
<li>新旧节点相同则直接返回</li>
<li>循环调用update钩子函数</li>
<li>判断是否为文本节点，如果和旧的一样就不处理，否则设置新节点的textContent</li>
<li>如果有children，新旧节点子节点不相同则调用updateChildren函数更新差异</li>
<li>如果新节点有children，旧节点没有，则清空textContent</li>
<li>如果老节点有children，新节点没有，就移除老节点</li>
<li>判断老节点是否存在text属性，有则清空</li>
<li>如果新旧节点都是文本节点且不相同，则清空旧节点内容</li>
<li>触发postpatch钩子函数</li>
</ol>
<p><strong>updateChildren diff 核心</strong></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">updateChildren</span> (<span class="params"><span class="attr">parentElm</span>: <span class="title class_">Node</span>,</span></span><br><span class="line"><span class="params">    <span class="attr">oldCh</span>: <span class="title class_">VNode</span>[],</span></span><br><span class="line"><span class="params">    <span class="attr">newCh</span>: <span class="title class_">VNode</span>[],</span></span><br><span class="line"><span class="params">    <span class="attr">insertedVnodeQueue</span>: <span class="title class_">VNodeQueue</span></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> oldStartIdx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> newStartIdx = <span class="number">0</span></span><br><span class="line">    <span class="keyword">let</span> oldEndIdx = oldCh.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> oldStartVnode = oldCh[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">let</span> oldEndVnode = oldCh[oldEndIdx]</span><br><span class="line">    <span class="keyword">let</span> newEndIdx = newCh.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> newStartVnode = newCh[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">let</span> newEndVnode = newCh[newEndIdx]</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">oldKeyToIdx</span>: <span class="title class_">KeyToIndexMap</span> | <span class="literal">undefined</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">idxInOld</span>: <span class="built_in">number</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">elmToMove</span>: <span class="title class_">VNode</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">before</span>: <span class="built_in">any</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldStartVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        oldStartVnode = oldCh[++oldStartIdx] <span class="comment">// Vnode might have been moved left</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldEndVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStartVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        newStartVnode = newCh[++newStartIdx]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newEndVnode == <span class="literal">null</span>) &#123;</span><br><span class="line">        newEndVnode = newCh[--newEndIdx]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newStartVnode)) &#123;</span><br><span class="line">        <span class="title function_">patchVnode</span>(oldStartVnode, newStartVnode, insertedVnodeQueue)</span><br><span class="line">        oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">        newStartVnode = newCh[++newStartIdx]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newEndVnode)) &#123;</span><br><span class="line">        <span class="title function_">patchVnode</span>(oldEndVnode, newEndVnode, insertedVnodeQueue)</span><br><span class="line">        oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">        newEndVnode = newCh[--newEndIdx]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldStartVnode, newEndVnode)) &#123; <span class="comment">// Vnode moved right</span></span><br><span class="line">        <span class="title function_">patchVnode</span>(oldStartVnode, newEndVnode, insertedVnodeQueue)</span><br><span class="line">        api.<span class="title function_">insertBefore</span>(parentElm, oldStartVnode.<span class="property">elm</span>!, api.<span class="title function_">nextSibling</span>(oldEndVnode.<span class="property">elm</span>!))</span><br><span class="line">        oldStartVnode = oldCh[++oldStartIdx]</span><br><span class="line">        newEndVnode = newCh[--newEndIdx]</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">sameVnode</span>(oldEndVnode, newStartVnode)) &#123; <span class="comment">// Vnode moved left</span></span><br><span class="line">        <span class="title function_">patchVnode</span>(oldEndVnode, newStartVnode, insertedVnodeQueue)</span><br><span class="line">        api.<span class="title function_">insertBefore</span>(parentElm, oldEndVnode.<span class="property">elm</span>!, oldStartVnode.<span class="property">elm</span>!)</span><br><span class="line">        oldEndVnode = oldCh[--oldEndIdx]</span><br><span class="line">        newStartVnode = newCh[++newStartIdx]</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (oldKeyToIdx === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          oldKeyToIdx = <span class="title function_">createKeyToOldIdx</span>(oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">        &#125;</span><br><span class="line">        idxInOld = oldKeyToIdx[newStartVnode.<span class="property">key</span> <span class="keyword">as</span> <span class="built_in">string</span>]</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isUndef</span>(idxInOld)) &#123; <span class="comment">// New element</span></span><br><span class="line">          api.<span class="title function_">insertBefore</span>(parentElm, <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue), oldStartVnode.<span class="property">elm</span>!)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          elmToMove = oldCh[idxInOld]</span><br><span class="line">          <span class="keyword">if</span> (elmToMove.<span class="property">sel</span> !== newStartVnode.<span class="property">sel</span>) &#123;</span><br><span class="line">            api.<span class="title function_">insertBefore</span>(parentElm, <span class="title function_">createElm</span>(newStartVnode, insertedVnodeQueue), oldStartVnode.<span class="property">elm</span>!)</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">patchVnode</span>(elmToMove, newStartVnode, insertedVnodeQueue)</span><br><span class="line">            oldCh[idxInOld] = <span class="literal">undefined</span> <span class="keyword">as</span> <span class="built_in">any</span></span><br><span class="line">            api.<span class="title function_">insertBefore</span>(parentElm, elmToMove.<span class="property">elm</span>!, oldStartVnode.<span class="property">elm</span>!)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        newStartVnode = newCh[++newStartIdx]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (oldStartIdx &lt;= oldEndIdx || newStartIdx &lt;= newEndIdx) &#123;</span><br><span class="line">      <span class="keyword">if</span> (oldStartIdx &gt; oldEndIdx) &#123;</span><br><span class="line">        before = newCh[newEndIdx + <span class="number">1</span>] == <span class="literal">null</span> ? <span class="literal">null</span> : newCh[newEndIdx + <span class="number">1</span>].<span class="property">elm</span></span><br><span class="line">        <span class="title function_">addVnodes</span>(parentElm, before, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">removeVnodes</span>(parentElm, oldCh, oldStartIdx, oldEndIdx)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>DOM操作时很少会跨级别操作节点</li>
<li>只比较同级别节点</li>
</ul>
<p>四个索引</p>
<ol>
<li>oldStartIdx</li>
<li>oldEndIdx</li>
<li>newStartIdx</li>
<li>newEndIdx</li>
</ol>
<p>排列组合有 13/24/14/23 四种情况<br>除上述情况外常规下可以使用 <strong>key</strong> 去对比</p>
<hr>
<p><strong>createElm 函数，创建真实DOM</strong></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">createElm</span> (<span class="params"><span class="attr">vnode</span>: <span class="title class_">VNode</span>, <span class="attr">insertedVnodeQueue</span>: <span class="title class_">VNodeQueue</span></span>): <span class="title class_">Node</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="attr">i</span>: <span class="built_in">any</span></span><br><span class="line">  <span class="keyword">let</span> data = vnode.<span class="property">data</span></span><br><span class="line">  <span class="keyword">if</span> (data !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> init = data.<span class="property">hook</span>?.<span class="property">init</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(init)) &#123;</span><br><span class="line">      <span class="title function_">init</span>(vnode)</span><br><span class="line">      data = vnode.<span class="property">data</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> children = vnode.<span class="property">children</span></span><br><span class="line">  <span class="keyword">const</span> sel = vnode.<span class="property">sel</span></span><br><span class="line">  <span class="keyword">if</span> (sel === <span class="string">&#x27;!&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode.<span class="property">text</span>)) &#123;</span><br><span class="line">      vnode.<span class="property">text</span> = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    vnode.<span class="property">elm</span> = api.<span class="title function_">createComment</span>(vnode.<span class="property">text</span>!)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sel !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="comment">// Parse selector</span></span><br><span class="line">    <span class="keyword">const</span> hashIdx = sel.<span class="title function_">indexOf</span>(<span class="string">&#x27;#&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> dotIdx = sel.<span class="title function_">indexOf</span>(<span class="string">&#x27;.&#x27;</span>, hashIdx)</span><br><span class="line">    <span class="keyword">const</span> hash = hashIdx &gt; <span class="number">0</span> ? hashIdx : sel.<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> dot = dotIdx &gt; <span class="number">0</span> ? dotIdx : sel.<span class="property">length</span></span><br><span class="line">    <span class="keyword">const</span> tag = hashIdx !== -<span class="number">1</span> || dotIdx !== -<span class="number">1</span> ? sel.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="title class_">Math</span>.<span class="title function_">min</span>(hash, dot)) : sel</span><br><span class="line">    <span class="keyword">const</span> elm = vnode.<span class="property">elm</span> = <span class="title function_">isDef</span>(data) &amp;&amp; <span class="title function_">isDef</span>(i = data.<span class="property">ns</span>)</span><br><span class="line">      ? api.<span class="title function_">createElementNS</span>(i, tag, data)</span><br><span class="line">      : api.<span class="title function_">createElement</span>(tag, data)</span><br><span class="line">    <span class="keyword">if</span> (hash &lt; dot) elm.<span class="title function_">setAttribute</span>(<span class="string">&#x27;id&#x27;</span>, sel.<span class="title function_">slice</span>(hash + <span class="number">1</span>, dot))</span><br><span class="line">    <span class="keyword">if</span> (dotIdx &gt; <span class="number">0</span>) elm.<span class="title function_">setAttribute</span>(<span class="string">&#x27;class&#x27;</span>, sel.<span class="title function_">slice</span>(dot + <span class="number">1</span>).<span class="title function_">replace</span>(<span class="regexp">/\./g</span>, <span class="string">&#x27; &#x27;</span>))</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; cbs.<span class="property">create</span>.<span class="property">length</span>; ++i) cbs.<span class="property">create</span>[i](emptyNode, vnode)</span><br><span class="line">    <span class="keyword">if</span> (is.<span class="title function_">array</span>(children)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; children.<span class="property">length</span>; ++i) &#123;</span><br><span class="line">        <span class="keyword">const</span> ch = children[i]</span><br><span class="line">        <span class="keyword">if</span> (ch != <span class="literal">null</span>) &#123;</span><br><span class="line">          api.<span class="title function_">appendChild</span>(elm, <span class="title function_">createElm</span>(ch <span class="keyword">as</span> <span class="title class_">VNode</span>, insertedVnodeQueue))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (is.<span class="title function_">primitive</span>(vnode.<span class="property">text</span>)) &#123;</span><br><span class="line">      api.<span class="title function_">appendChild</span>(elm, api.<span class="title function_">createTextNode</span>(vnode.<span class="property">text</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> hook = vnode.<span class="property">data</span>!.<span class="property">hook</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isDef</span>(hook)) &#123;</span><br><span class="line">      hook.<span class="property">create</span>?.(emptyNode, vnode)</span><br><span class="line">      <span class="keyword">if</span> (hook.<span class="property">insert</span>) &#123;</span><br><span class="line">        insertedVnodeQueue.<span class="title function_">push</span>(vnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    vnode.<span class="property">elm</span> = api.<span class="title function_">createTextNode</span>(vnode.<span class="property">text</span>!)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vnode.<span class="property">elm</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="vnode-ts"><a href="#vnode-ts" class="headerlink" title="vnode.ts"></a>vnode.ts</h2><p><strong>vnode 定义</strong></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">vnode</span> (<span class="params"></span></span><br><span class="line"><span class="params">  <span class="attr">sel</span>: <span class="built_in">string</span> | <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">data</span>: <span class="built_in">any</span> | <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">children</span>: <span class="title class_">Array</span>&lt;<span class="title class_">VNode</span> | <span class="built_in">string</span>&gt; | <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">text</span>: <span class="built_in">string</span> | <span class="literal">undefined</span>,</span></span><br><span class="line"><span class="params">  <span class="attr">elm</span>: <span class="title class_">Element</span> | <span class="title class_">Text</span> | <span class="literal">undefined</span></span>): <span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> key = data === <span class="literal">undefined</span> ? <span class="literal">undefined</span> : data.<span class="property">key</span></span><br><span class="line">  <span class="keyword">return</span> &#123; sel, data, children, text, elm, key &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="hooks-ts"><a href="#hooks-ts" class="headerlink" title="hooks.ts"></a>hooks.ts</h2><p><strong>定义各种钩子类型</strong></p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">Hooks</span> &#123;</span><br><span class="line">  <span class="attr">pre</span>?: <span class="title class_">PreHook</span></span><br><span class="line">  <span class="attr">init</span>?: <span class="title class_">InitHook</span></span><br><span class="line">  <span class="attr">create</span>?: <span class="title class_">CreateHook</span></span><br><span class="line">  <span class="attr">insert</span>?: <span class="title class_">InsertHook</span></span><br><span class="line">  <span class="attr">prepatch</span>?: <span class="title class_">PrePatchHook</span></span><br><span class="line">  <span class="attr">update</span>?: <span class="title class_">UpdateHook</span></span><br><span class="line">  <span class="attr">postpatch</span>?: <span class="title class_">PostPatchHook</span></span><br><span class="line">  <span class="attr">destroy</span>?: <span class="title class_">DestroyHook</span></span><br><span class="line">  <span class="attr">remove</span>?: <span class="title class_">RemoveHook</span></span><br><span class="line">  <span class="attr">post</span>?: <span class="title class_">PostHook</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="thunk-ts"><a href="#thunk-ts" class="headerlink" title="thunk.ts"></a>thunk.ts</h2><p><strong>优化处理，对复杂视图不可变化的处理</strong></p>
<h2 id="tovnode-ts"><a href="#tovnode-ts" class="headerlink" title="tovnode.ts"></a>tovnode.ts</h2><p><strong>真实DOM转vnode工具函数</strong></p>
<h2 id="htmldomapi-ts"><a href="#htmldomapi-ts" class="headerlink" title="htmldomapi.ts"></a>htmldomapi.ts</h2><p><strong>定义DOM API</strong></p>
<!-- refrence: [snabbdom_source] -->
  </div>
</article>

        
        
      </div>
      <footer class="footer">
    <div class="footer-content">
        <p>&copy; 2025 蘑菇小记</p>
        <p class="copyright">All rights reserved.</p>
    </div>
</footer>
    </div>
    <button id="back-to-top" title="回到顶部">↑</button>
  </body>
</html>
